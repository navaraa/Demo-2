<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Navaraa Staking UI</title> <!--
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  --->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!---- connect for mobile version ---->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');
    
    *{
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      text-decoration: none;
      border: none;
      outline: none;
      scroll-behavior: smooth;
    }
    
    body { 
      font-family: 'Poppins', sans-serif; 
      background:#f5f5f5;
    }
    
  /*______________________SECTION 1 : header design__________________*/
   .header {
     background: #a29bfe;
     box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* neeche soft transparent line */
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     padding: 1rem 9%;
     display: flex;
     justify-content: space-between;
     align-items: center;
     z-index: 100;  
   }
    .logo-container {
      display: flex;
      align-items: center;
    }
    .logo-img {
      height: 125px;  /* apne logo ka size adjust kar sakte ho */
      width: auto;
      border-radius: 8px;
    }
    .btn { 
      background: #4CAF50;          /* green background */
      color: #fff;                  /* white text */
      font-family: 'Poppins', sans-serif;
      font-size: 28px;              /* normal readable size */
      padding: 10px 20px;           /* andar ka gap */
      border: none;
      border-radius: 10px;           /* thoda rounded */
      cursor: pointer;
      font-weight: 500;
    }
    .btn:hover { 
      background: #45a049;          /* thoda dark green */
    }
    .danger { 
      background: #e53935;          /* red */
    }
    .danger:hover {
      background: #d32f2f;          /* dark red */
    }
/*--**************************- -E N D--****************************-*/
    
    /*___________SECTION 2 & 3: WALLET INFO + Total stake count_______*/
    .main-content {
      margin-top: 150px;
      Padding: 0px 20px;
    }
    .wallet-info, 
    .total-stake {
      display: flex;
      justify-content: center;   /* horizontal center */
      margin: 20px 0;
    }
    .w-add,
    .stake-text,
    .stake-no {
      display: flex;
      align-items: center;
      background: #fff;          /* white box */
      padding: 12px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* modern soft shadow */
      font-size: 28px;
      font-weight: 700;
      color: #333;
      min-width: 30%;          /* thoda bada box */
      justify-content: center;   /* icon + address center me */
    }
    .total-stake {
      gap: 20px
    }
    .wallet-balances {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 15px;
}

.token-balance {
  display: flex;
  align-items: center;
  background: #fff;
  padding: 10px 15px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  font-size: 18px;
  font-weight: 600;
  color: #333;
}

.token-balance img {
  width: 28px;
  height: 28px;
  margin-right: 8px;
  border-radius: 50%;
}

    
    /*__________________SECTION 4 : User stake card (dymenic)____________________*/

    /* Container jisme cards center me show honge */
#stakeCards {
  display: flex;
  flex-direction: column;   /* ek ke neeche ek */
  align-items: center;      /* horizontal center */
  gap: 20px;                /* cards ke beech gap */
  padding: 20px;
}

/* Har stake ka card */
.card {
  background: #1e1e2f;
  color: #fff;
  border-radius: 15px;
  padding: 25px;
  width: 90%;              /* screen ke hisaab se adjust hoga */
  max-width: 450px;        /* ek fixed max width taaki bada na ho */
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* Hover effect */
.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

/* Text styling */
.card p {
  margin: 10px 0;
  font-size: 16px;
  line-height: 1.6;
}

/* Buttons */
.btn, .danger {
  display: inline-block;
  margin-top: 10px;
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: bold;
  transition: 0.2s ease;
}

/* Claim button */
.btn {
  background: #4cafef;
  color: white;
}

.btn:hover {
  background: #2196f3;
}

/* Withdraw button */
.danger {
  background: #f44336;
  color: white;
}

.danger:hover {
  background: #d32f2f;
}
    .card-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 15px;
  border-bottom: 1px solid #444;
  padding-bottom: 8px;
}

.card-actions {
  margin-top: 20px;
  display: flex;
  justify-content: space-between;
}
    .card-actions button {
      flex: 1;
      margin: 0 5px;
    }
    .card .end-date {
  margin-top: 15px;
  text-align: center;
  font-size: 14px;
  color: #ccc;
    }
    
    
    .token-name {
  margin-left: 4px;
  font-weight: 500;
  color: #ccc;
}

        /*__________________SECTION 5 : Bottom menu icon____________________*/

    .bottom-menu {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 65px;
  background: #fff;
  display: flex;
  justify-content: space-around;
  align-items: center;
  border-top: 1px solid #ddd;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
  z-index: 1000;
}

.menu-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  color: #444;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

.menu-item i {
  font-size: 20px;
  margin-bottom: 4px;
  color: #5a67d8; /* theme color */
}

.menu-item:hover {
  color: #000;
  transform: translateY(-2px);
}
    
    /*----_-------------------Stake working--------------------------,*/
/* -------- Stake Modal -------- */
#stakeModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#stakeModal .modal-content {
  background: #1e1e2f;
  padding: 25px;
  border-radius: 15px;
  width: 90%;
  max-width: 400px;
  color: #fff;
  text-align: center;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
}

#stakeModal .modal-content h2 {
  margin-bottom: 20px;
}

#stakeModal .modal-content input {
  padding: 10px;
  width: 100%;
  border-radius: 8px;
  border: 1px solid #444;
  margin-bottom: 20px;
  font-size: 16px;
  color: #333;
}

#stakeModal .modal-buttons {
  display: flex;
  justify-content: space-between;
  gap: 10px;
}

#stakeModal .modal-buttons button {
  flex: 1;
}



    
  </style>
</head>
  <body>
  <!------------- h t m l   c o d e    h e r e ------->
    <!--- Section_1: header ( logo.png + logo text + connect wallet) ----->
      <header class="header">
        <div class="logo-container">
          <img src="logo.png" alt="Logo" class="logo-img" />
        </div>
         <button id="connectButton" class="btn">Connect Wallet</button>
      </header>
  <!----Section 2 : wallet address ---------->
    <div class="main-content" >
      <div class="wallet-info">
        <div class="w-add" id="wallet">"Not Connected"</div>
      </div>
      <!-- Wallet balances section -->
<div class="wallet-balances" id="walletBalances"></div>
      
    </div>
    <!----Section 3 : Total stake count ------>
      <div class="total-stake">
        <div class="stake-text">Total Stake:</div> 
        <div class="stake-no" id="stakeCount">-</div>
      </div>
    <!----Section 4 : User Stake Cards (dynamic)---->
    <div id="stakeCards"></div>

    <!----Section 5 : Bottom menu icon------EXTRA---->

    <!-- ‚úÖ Bottom Fixed Menu -->
<div class="bottom-menu">
  <div class="menu-item" onclick="openRefer()">
    <i class="fas fa-user-friends"></i>
    <span>Refer & Earn</span>
  </div>
  <div class="menu-item" onclick="openStake()">
    <i class="fas fa-coins"></i>
    <span>Stake Now</span>
  </div>
  <div class="menu-item" onclick="openHistory()">
    <i class="fas fa-receipt"></i>
    <span>History</span>
  </div>
</div>
    <!----Section 5 : Stake working------EXTRA---->

    <!-- Stake Modal -->
<div id="stakeModal" style="display:none;">
  <div class="modal-content">
    <h2>Stake Navaa</h2>
    <input type="number" id="stakeAmount" placeholder="Enter amount" />
    <div class="modal-buttons">
      <button onclick="stakeNow()" class="btn">Stake Now</button>
      <button onclick="closeStake()" class="danger">Cancel</button>
    </div>
  </div>
</div>
    
  
<!---------------------J A V A S C R I P T-----S T A R T------------------------------->
  <script>
    const CONTRACT_ADDRESS = "0x9fd473975cecd4587d78eb71f4498dde778c4b83";
    // ‚úÖ Navaa token address (apna asli address daalna yahan)
const NAVAA_TOKEN = "0x23b7a4c2ec9d742b5b1698149e812ca1e10d3e73";

// ‚úÖ ERC20 ke liye chhota ABI
const TOKEN_ABI = [
  "function balanceOf(address account) view returns (uint256)",
  "function decimals() view returns (uint8)"
];
    const ABI = [
  "function stakeCount(address user) view returns (uint256)",
  "function pendingRewardForStake(address user, uint256 index) view returns (uint256)",
  "function getStake(address user, uint256 index) view returns (uint256 amount, uint256 startTime, uint256 claimed, bool principalWithdrawn, uint256 totalReward)",
  "function claimStakingRewards(uint256[] calldata indices)",
  "function withdrawPrincipal(uint256[] calldata indices)"
];
    
    let provider, signer, contract, userAddress;
    
    /***********Desktop+Mobile wallet connect ******/
    
async function connectWallet() {
  if (window.ethereum) {
    // ‚úÖ MetaMask (Desktop + Mobile)
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);

    // üîç Network check (Polygon only)
    const network = await provider.getNetwork();
    if (network.chainId !== 137) {
      alert("‚ö†Ô∏è Please switch to Polygon Mainnet (Chain ID 137) in your wallet.");
      return;
    }

  } else {
    // ‚úÖ Trust Wallet / Others via WalletConnect
    const wcProvider = new WalletConnectProvider.default({
      rpc: {
        137: "https://polygon-rpc.com"
      },
    });
    await wcProvider.enable();
    provider = new ethers.providers.Web3Provider(wcProvider);

    // üîç Check again
    const network = await provider.getNetwork();
    if (network.chainId !== 137) {
      alert("‚ö†Ô∏è Please switch to Polygon Mainnet (Chain ID 137).");
      return;
    }
  }

  signer = provider.getSigner();
  userAddress = await signer.getAddress();
  document.getElementById("wallet").innerText = userAddress;
  const connectBtn = document.getElementById("connectButton");
  connectBtn.innerText = "Connected";
  connectBtn.disabled = true;
  connectBtn.style.background = "#2e7d32";
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  loadInfo();
  await loadBalances();
}  

    /*__________________Total Card design________________ */

    async function loadInfo() {
  try {
    const count = await contract.stakeCount(userAddress);
    document.getElementById("stakeCount").innerText = count.toString();

    const stakeCardsContainer = document.getElementById("stakeCards");
    stakeCardsContainer.innerHTML = ""; // purane cards clear karo

    for (let i = 0; i < count; i++) {
      const pending = await contract.pendingRewardForStake(userAddress, i);
      const stakeInfo = await contract.getStake(userAddress, i);

      const amount = stakeInfo.amount;  
      const startDate = new Date(stakeInfo.startTime.toNumber() * 1000);
      const totalReward = stakeInfo.totalReward;

      // üîπ End Date calculate karo (1700 din ka duration)
      const STAKE_DURATION = 1700 * 24 * 60 * 60; 
      const endTime = new Date((stakeInfo.startTime.toNumber() + STAKE_DURATION) * 1000);

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h3 class="card-title">Stake #${i}</h3>
        <p><b>Staked Amount:</b> ${ethers.utils.formatEther(amount)} Navaa</p>
        <p><b>Start Date:</b> ${startDate.toLocaleString()}</p>
        <p><b>Total Reward:</b> ${ethers.utils.formatEther(totalReward)} Navaa</p>
        <p><b>Pending Reward:</b>
          <span id="pending-${i}">${ethers.utils.formatEther(pending)}</span> 
          <span class="token-name">Navaa</span>
        </p>
        <div class="card-actions">
          <button class="btn claimBtn" data-index="${i}">Claim Reward</button>
          <button class="danger withdrawBtn" data-index="${i}">Withdraw Principal</button>
        </div>
        <p><b>End Date:</b> <span id="end-${i}"></span></p>
      `;
      stakeCardsContainer.appendChild(card);

      // üîÑ Pending Reward ko live update karna
      let pendingLive = parseFloat(ethers.utils.formatEther(pending));
      const totalRewardNum = parseFloat(ethers.utils.formatEther(totalReward));
      const rewardRatePerSecond = totalRewardNum / STAKE_DURATION;

      setInterval(() => {
        pendingLive += rewardRatePerSecond;
        document.getElementById(`pending-${i}`).innerText = pendingLive.toFixed(6);
      }, 1000);

      // üîÑ End Date ko live update karna
      function updateEndTime() {
        document.getElementById(`end-${i}`).innerText = endTime.toLocaleString();
      }
      updateEndTime(); // pehli baar
      setInterval(updateEndTime, 1000); // har second update
    }

    // ‚úÖ Buttons activate karo
    document.querySelectorAll(".claimBtn").forEach(btn => {
      btn.onclick = () => claimReward(btn.dataset.index);
    });

    document.querySelectorAll(".withdrawBtn").forEach(btn => {
      btn.onclick = () => withdrawPrincipal(btn.dataset.index);
    });

  } catch (err) {
    console.error(err);
    alert("Error loading info: " + err.message);
  }
}
// ‚úÖ POL aur Navaa Balance with Logo
async function loadBalances() {
  if (!provider || !userAddress) return;

  // POL balance
  const polBalance = await provider.getBalance(userAddress);
  const polFormatted = ethers.utils.formatEther(polBalance);

  // Navaa balance
  const navaaContract = new ethers.Contract(NAVAA_TOKEN, TOKEN_ABI, provider);
  const navaaBalance = await navaaContract.balanceOf(userAddress);
  const navaaDecimals = await navaaContract.decimals();
  const navaaFormatted = ethers.utils.formatUnits(navaaBalance, navaaDecimals);

  // UI update
  document.getElementById("walletBalances").innerHTML = `
    <div class="token-balance">
      <img src="POL.png" alt="MATIC">
      ${parseFloat(polFormatted).toFixed(4)} POL
    </div>
    <div class="token-balance">
      <img src="logo.png" alt="Navaa">
      ${parseFloat(navaaFormatted).toFixed(4)} Navaa
    </div>
  `;
}
    
    ///////////////////////////////////////
    async function claimReward(index) {
  try {
    const tx = await contract.claimStakingRewards([index]);
    alert("Claiming stake #" + index + " ... Tx: " + tx.hash);
    await tx.wait();
    alert("Reward claimed for stake #" + index);
    loadInfo();
  } catch (err) {
    console.error(err);
    alert("Claim failed: " + err.message);
  }
}

async function withdrawPrincipal(index) {
  try {
    const tx = await contract.withdrawPrincipal([index]);
    alert("Withdrawing stake #" + index + " ... Tx: " + tx.hash);
    await tx.wait();
    alert("Principal withdrawn for stake #" + index);
    loadInfo();
  } catch (err) {
    console.error(err);
    alert("Withdraw failed: " + err.message);
  }
}

    /*-------------------------------End Extra---------------------*/
    document.getElementById("connectButton").onclick = connectWallet;

    ////////////////////////
function openStake() {
  document.getElementById("stakeModal").style.display = "flex";
}

function closeStake() {
  document.getElementById("stakeModal").style.display = "none";
}

async function stakeNow() {
  try {
    const amountInput = document.getElementById("stakeAmount").value;

    if (!amountInput || isNaN(amountInput) || parseFloat(amountInput) <= 0) {
      alert("Enter a valid amount");
      return;
    }

    const amount = ethers.utils.parseUnits(amountInput.toString(), 18);

    // Approve token
    const tokenContract = new ethers.Contract(NAVAA_TOKEN, [
      "function approve(address spender, uint256 amount) returns (bool)"
    ], signer);

    const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, amount);
    alert("Approving tokens... Tx: " + approveTx.hash);
    await approveTx.wait();

    // Stake tokens (referrer = 0 ‚Üí management wallet used)
    const tx = await contract.stakeTokens(amount, ethers.constants.AddressZero);
    alert("Staking... Tx: " + tx.hash);
    await tx.wait();

    alert("‚úÖ Stake successful!");
    closeStake();

    loadInfo();
    loadBalances();

  } catch (err) {
    console.error(err);
    alert("Stake failed: " + (err?.reason || err?.message || "Unknown error"));
  }
}


    //////////////////////////

// üëá yahan se new functions for bottom menu
function openRefer() {
  alert("Refer & Earn clicked!");
}
    /*

function openStake() {
  alert("Stake Now clicked!");
} */

function openHistory() {
  alert("Claim/Withdrawal History clicked!");
}
  </script>
</body>
</html>


